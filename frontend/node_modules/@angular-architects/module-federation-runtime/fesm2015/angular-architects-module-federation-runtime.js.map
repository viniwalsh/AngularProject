{"version":3,"file":"angular-architects-module-federation-runtime.js","sources":["../../../../libs/mf-runtime/src/lib/loader/dynamic-federation.ts","../../../../libs/mf-runtime/src/angular-architects-module-federation-runtime.ts"],"sourcesContent":["type Scope = unknown;\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\ntype Factory = () => any;\r\n\r\ntype Container = {\r\n    init(shareScope: Scope): void;\r\n    get(module: string): Factory;\r\n};\r\n\r\nlet config: Manifest = {};\r\n\r\nexport type ManifestFile<T extends RemoteConfig = RemoteConfig>  = {\r\n    [key: string]: string | T;\r\n};\r\n\r\nexport type Manifest<T extends RemoteConfig = RemoteConfig> = {\r\n    [key: string]: T;\r\n};\r\n\r\nexport type RemoteConfig = {\r\n    type: 'module' | 'script',\r\n    remoteEntry: string,\r\n    [key: string]: unknown\r\n};\r\n\r\ndeclare const __webpack_init_sharing__: (shareScope: string) => Promise<void>;\r\ndeclare const __webpack_share_scopes__: { default: Scope };\r\n\r\ntype ContainerMap = { [key: string]: Container };\r\n\r\nconst containerMap: ContainerMap = {};\r\nconst remoteMap = {}\r\n\r\nlet isDefaultScopeInitialized = false;\r\n\r\nasync function lookupExposedModule<T>(key: string, exposedModule: string): Promise<T> {\r\n      const container = containerMap[key];\r\n      const factory = await container.get(exposedModule);\r\n      const Module = factory();\r\n      return Module as T;\r\n}\r\n\r\nasync function initRemote(container: Container, key:string) {\r\n    // const container = window[key] as Container;\r\n\r\n    // Do we still need to initialize the remote?\r\n    if (remoteMap[key]) {\r\n        return container;\r\n    }\r\n\r\n    // Do we still need to initialize the share scope?\r\n    if (!isDefaultScopeInitialized) { \r\n        await __webpack_init_sharing__('default');\r\n        isDefaultScopeInitialized = true;\r\n    }\r\n\r\n    await container.init(__webpack_share_scopes__.default);\r\n    remoteMap[key] = true;\r\n    return container;\r\n}\r\n\r\nexport type LoadRemoteEntryOptions = LoadRemoteEntryScriptOptions | LoadRemoteEntryEsmOptions;\r\n\r\nexport type LoadRemoteEntryScriptOptions = {\r\n    type?: 'script';\r\n    remoteEntry: string;\r\n    remoteName: string;\r\n}\r\n\r\nexport type LoadRemoteEntryEsmOptions = {\r\n    type: 'module';\r\n    remoteEntry: string;\r\n}\r\n\r\nexport async function loadRemoteEntry(remoteEntry: string, remoteName: string): Promise<void>;\r\nexport async function loadRemoteEntry(options: LoadRemoteEntryOptions): Promise<void>;\r\nexport async function loadRemoteEntry(remoteEntryOrOptions: string | LoadRemoteEntryOptions, remoteName?: string): Promise<void> {\r\n    if (typeof remoteEntryOrOptions === 'string') {\r\n        const remoteEntry = remoteEntryOrOptions;\r\n        return await loadRemoteScriptEntry(remoteEntry, remoteName);\r\n    }\r\n    else if (remoteEntryOrOptions.type === 'script') {\r\n        const options = remoteEntryOrOptions;\r\n        return await loadRemoteScriptEntry(options.remoteEntry, options.remoteName);\r\n    }\r\n    else if (remoteEntryOrOptions.type === 'module') {\r\n        const options = remoteEntryOrOptions;\r\n        await loadRemoteModuleEntry(options.remoteEntry);\r\n    }\r\n}\r\n\r\nasync function loadRemoteModuleEntry(remoteEntry: string): Promise<void> {\r\n    if (containerMap[remoteEntry]) {\r\n        return Promise.resolve();\r\n    }\r\n    return await import(/* webpackIgnore:true */remoteEntry).then(container => { \r\n        initRemote(container, remoteEntry); \r\n        containerMap[remoteEntry] = container;\r\n    });\r\n}\r\n\r\nasync function loadRemoteScriptEntry(remoteEntry: string, remoteName: string): Promise<void> {\r\n    return new Promise<void>((resolve, reject) => {\r\n\r\n        // Is remoteEntry already loaded?\r\n        if (containerMap[remoteName]) {\r\n            resolve();\r\n            return;\r\n        }\r\n\r\n        const script = document.createElement('script');\r\n        script.src = remoteEntry;\r\n\r\n        script.onerror = reject;\r\n\r\n        script.onload = () => {\r\n            const container = window[remoteName] as Container;\r\n            initRemote(container, remoteName);\r\n            containerMap[remoteName] = container;\r\n            resolve(); \r\n        }\r\n\r\n        document.body.appendChild(script);\r\n    });\r\n}\r\n\r\nexport type LoadRemoteModuleOptions = LoadRemoteModuleScriptOptions | LoadRemoteModuleEsmOptions | LoadRemoteModuleManifestOptions;\r\n\r\nexport type LoadRemoteModuleScriptOptions = { \r\n    type?: 'script';\r\n    remoteEntry?: string; \r\n    remoteName: string; \r\n    exposedModule: string;\r\n} \r\n\r\nexport type LoadRemoteModuleEsmOptions = { \r\n    type: 'module';\r\n    remoteEntry: string; \r\n    exposedModule: string;\r\n} \r\n\r\nexport type LoadRemoteModuleManifestOptions = { \r\n    type: 'manifest';\r\n    remoteName: string; \r\n    exposedModule: string;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport async function loadRemoteModule<T = any>(options: LoadRemoteModuleOptions): Promise<T> {\r\n\r\n    let loadRemoteEntryOptions: LoadRemoteEntryOptions;\r\n    let key: string;\r\n    let remoteEntry: string;\r\n\r\n    // To support legacy API (< ng 13)\r\n    if (!options.type) {\r\n        options.type = 'script';\r\n    }\r\n\r\n    if (options.type === 'manifest') {\r\n        const manifestEntry = config[options.remoteName];\r\n        if (!manifestEntry) {\r\n            throw new Error('Manifest does not contain ' + options.remoteName);\r\n        }\r\n        options = {\r\n            type: manifestEntry.type,\r\n            exposedModule: options.exposedModule,\r\n            remoteEntry: manifestEntry.remoteEntry,\r\n            remoteName: (manifestEntry.type === 'script') ? options.remoteName : undefined\r\n        }\r\n        remoteEntry = manifestEntry.remoteEntry;\r\n    }\r\n    else {\r\n        remoteEntry = options.remoteEntry;\r\n    }\r\n\r\n    if (options.type === 'script') {\r\n        loadRemoteEntryOptions = {\r\n            type: 'script',\r\n            remoteEntry: options.remoteEntry,\r\n            remoteName: options.remoteName\r\n        };\r\n        key = options.remoteName;\r\n    }\r\n    else if (options.type === 'module') {\r\n        loadRemoteEntryOptions = {\r\n            type: 'module',\r\n            remoteEntry: options.remoteEntry,\r\n        };\r\n        key = options.remoteEntry;\r\n    }\r\n\r\n    if (remoteEntry) {\r\n        await loadRemoteEntry(loadRemoteEntryOptions);\r\n    }\r\n\r\n    return await lookupExposedModule<T>(key, options.exposedModule);\r\n}\r\n\r\nexport async function setManifest(manifest: ManifestFile, skipRemoteEntries = false) {\r\n    config = parseConfig(manifest);\r\n    \r\n    if (!skipRemoteEntries) {\r\n        await loadRemoteEntries();\r\n    }\r\n}\r\n\r\nexport function getManifest<T extends Manifest>(): T {\r\n    return config as T;\r\n}\r\n\r\nexport async function loadManifest(configFile: string, skipRemoteEntries = false): Promise<void> {\r\n\r\n    const result = await fetch(configFile);\r\n\r\n    if (!result.ok) {\r\n        throw Error('could not load configFile: ' + configFile);\r\n    }\r\n    \r\n    config = parseConfig(await result.json());\r\n    \r\n    if (!skipRemoteEntries) {\r\n        await loadRemoteEntries();\r\n    }\r\n}\r\n\r\nfunction parseConfig(config: ManifestFile): Manifest {\r\n    const result: Manifest = {};\r\n    for (let key in config) {\r\n        const value = config[key];\r\n\r\n        let entry: RemoteConfig;\r\n        if (typeof value === 'string') {\r\n            entry = {\r\n                remoteEntry: value,\r\n                type: 'module'\r\n            };\r\n        }\r\n        else {\r\n            entry = {\r\n                ...value,\r\n                type: value.type || 'module'\r\n            }\r\n        }\r\n\r\n        result[key] = entry;\r\n    }\r\n    return result;\r\n}\r\n\r\nasync function loadRemoteEntries() {\r\n    const promises: Promise<void>[] = [];\r\n\r\n    for (let key in config) {\r\n        const entry = config[key];\r\n\r\n        if (entry.type === 'module') {\r\n            promises.push(loadRemoteEntry({ type: 'module', remoteEntry: entry.remoteEntry }));\r\n        }\r\n        else {\r\n            promises.push(loadRemoteEntry({ type: 'script', remoteEntry: entry.remoteEntry, remoteName: key }));\r\n        }\r\n    }\r\n\r\n    await Promise.all(promises);\r\n}","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}